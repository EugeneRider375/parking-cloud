
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tableau de bord</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            display: flex;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #sidebar {
            width: 300px;
            padding: 10px;
            background: #f9f9f9;
            border-right: 1px solid #ccc;
        }
        #map {
            flex-grow: 1;
            height: 100vh;
        }
        h2 {
            margin-top: 0;
        }
        select, p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>ðŸš¦ Tableau de bord</h2>
        <p><strong>DerniÃ¨re mise Ã  jour :</strong> <span id="last-update">â€”</span></p>
        <label for="zone-select">Filtrer par zone :</label>
        <select id="zone-select">
            <option value="all">Toutes les zones</option>
        </select>
        <h3>Statistiques par zone :</h3>
        <p><strong>Total :</strong></p>
        <p>Libres : <span id="free-count">0</span></p>
        <p>OccupÃ©es : <span id="occupied-count">0</span></p>
        <p>Total des places : <span id="total-count">0</span></p>
        <h4>Journal des changements :</h4>
        <ul id="change-log"></ul>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([49.3601, 0.0831], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        let allMarkers = [];
        let allData = [];

        const zoneSelect = document.getElementById("zone-select");
        const freeCount = document.getElementById("free-count");
        const occupiedCount = document.getElementById("occupied-count");
        const totalCount = document.getElementById("total-count");
        const changeLog = document.getElementById("change-log");
        const lastUpdate = document.getElementById("last-update");

        function updateStats(filtered) {
            let free = filtered.filter(s => s.status === "free").length;
            let occupied = filtered.filter(s => s.status === "occupied").length;
            freeCount.textContent = free;
            occupiedCount.textContent = occupied;
            totalCount.textContent = filtered.length;
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }

        function drawMarkers(data) {
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];

            const selectedZone = zoneSelect.value;
            const filtered = selectedZone === "all" ? data : data.filter(s => s.zone === selectedZone);

            updateStats(filtered);

            filtered.forEach(spot => {
                const color = spot.status === "occupied" ? "red" : "green";
                const marker = L.circleMarker([spot.lat, spot.lng], {
                    radius: 8,
                    fillColor: color,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`${spot.zone}<br>${spot.status}`);
                allMarkers.push(marker);
            });
        }

        fetch("static/parking_spots.json")
            .then(res => res.json())
            .then(data => {
                allData = data;

                const zones = [...new Set(data.map(s => s.zone))];
                zones.forEach(z => {
                    const option = document.createElement("option");
                    option.value = z;
                    option.textContent = z;
                    zoneSelect.appendChild(option);
                });

                drawMarkers(data);
            });

        zoneSelect.addEventListener("change", () => drawMarkers(allData));
    </script>
</body>
</html>
